<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Agentic AI Chatbot</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root" class="min-h-screen bg-gray-100 flex flex-col items-center justify-center p-4"></div>
    <script type="text/babel">
        function Chatbot() {
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [sessionId, setSessionId] = React.useState(null);

            // Load conversation history on mount
            React.useEffect(() => {
                const loadHistory = async () => {
                    try {
                        const response = await fetch('/api/history', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: 'default_user', session_id: sessionId || '' })
                        });
                        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                        const data = await response.json();
                        if (data.history) {
                            setMessages(data.history.map(msg => ({
                                sender: msg.role,
                                text: msg.content,
                                sources: msg.role === 'assistant' ? 'From history' : null
                            })));
                        }
                    } catch (error) {
                        console.error('Error loading history:', error);
                    }
                };
                if (sessionId) loadHistory();
            }, [sessionId]);

            const sendMessage = async () => {
                if (!input.trim()) return;
                setIsLoading(true);
                const userMessage = { sender: 'user', text: input };
                setMessages([...messages, userMessage]);

                try {
                    const response = await fetch('/api/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question: input,
                            user_id: 'default_user',
                            session_id: sessionId,
                            n_results: 3
                        })
                    });
                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                    const data = await response.json();
                    const sources = data.metadata ? data.metadata.join(', ') : 'No specific sources';
                    const botMessage = { 
                        sender: 'bot', 
                        text: data.answer || 'No response received',
                        sources
                    };
                    setMessages(prev => [...prev, botMessage]);
                    if (data.session_id && !sessionId) {
                        setSessionId(data.session_id);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    const errorMessage = { sender: 'bot', text: 'Sorry, something went wrong.' };
                    setMessages(prev => [...prev, errorMessage]);
                }

                setInput('');
                setIsLoading(false);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !isLoading) {
                    sendMessage();
                }
            };

            return (
                <div className="w-full max-w-2xl bg-white rounded-lg shadow-lg p-6">
                    <h1 className="text-2xl font-bold text-center mb-4">Audit Agentic AI Chatbot</h1>
                    <div className="h-96 overflow-y-auto mb-4 p-4 border rounded-lg bg-gray-50">
                        {messages.map((msg, index) => (
                            <div key={index} className={`mb-2 ${msg.sender === 'user' || msg.sender === 'human' ? 'text-right' : 'text-left'}`}>
                                <span className={`inline-block p-2 rounded-lg ${msg.sender === 'user' || msg.sender === 'human' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}`}>
                                    {msg.text}
                                    {msg.sender === 'bot' && msg.sources && (
                                        <div className="text-xs text-gray-500 mt-1">Sources: {msg.sources}</div>
                                    )}
                                </span>
                            </div>
                        ))}
                        {isLoading && <div className="text-center text-gray-500">Loading...</div>}
                    </div>
                    <div className="flex">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={handleKeyPress}
                            className="flex-1 p-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Ask a question..."
                            disabled={isLoading}
                        />
                        <button
                            onClick={sendMessage}
                            className="p-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 disabled:bg-blue-300"
                            disabled={isLoading}
                        >
                            Send
                        </button>
                    </div>
                </div>
            );
        }

        try {
            ReactDOM.render(<Chatbot />, document.getElementById('root'));
        } catch (e) {
            console.error('React rendering error:', e);
            document.getElementById('root').innerHTML = '<p>Error loading chatbot. Check console for details.</p>';
        }
    </script>
</body>
</html>
